# syntax=docker/dockerfile:1

ARG BASE_IMG                       # e.g. swebench/â€¦:latest
ARG NODE_MAJOR=20                  # pin Node line if you like

FROM --platform=linux/amd64 node:${NODE_MAJOR}-slim AS node

FROM --platform=linux/amd64 ${BASE_IMG}

USER root

RUN set -eux; \
    if command -v apt-get > /dev/null; then \
      apt-get update && \
      apt-get install -y --no-install-recommends grep && \
      rm -rf /var/lib/apt/lists/*; \
    elif command -v apk > /dev/null; then \
      apk add --no-cache grep; \
    elif command -v yum > /dev/null; then \
      yum install -y grep; \
    else \
      echo "ERROR: no supported package manager found; please install grep manually" >&2; \
      exit 1; \
    fi

COPY --from=node /usr/local/bin/  /usr/local/bin/
COPY --from=node /usr/local/lib/  /usr/local/lib/

ARG CACHEBUST=1
RUN cd .. \
  && git clone https://github.com/ethanewer/qwen-agent.git \
  && cd qwen-agent \
  && npm install \
  && npm install -g . \
  && npm cache clean --force && rm -rf /root/.npm

RUN cd .. \
  && mkdir root/.qwen \
  && echo '{ "selectedAuthType": "openai" }' > ../root/.qwen/settings.json
